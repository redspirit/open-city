!function(e){"use strict";void 0===e.wesa&&(e.wesa=function(){const e={fromTranslation:function(e){let t=new Float32Array(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t},ortho:function(e,t,i,o,n,r){let s=new Float32Array(16),a=1/(e-t),l=1/(i-o),c=1/(n-r);return s[0]=-2*a,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2*l,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=2*c,s[11]=0,s[12]=(e+t)*a,s[13]=(o+i)*l,s[14]=(r+n)*c,s[15]=1,s}};function t(e,t,i){const o=e.createShader(t);return e.shaderSource(o,i),e.compileShader(o),e.getShaderParameter(o,e.COMPILE_STATUS)?o:(console.error("WESA Core: An error occurred compiling the shaders: "+e.getShaderInfoLog(o)),e.deleteShader(o),null)}const i={source:{spriteSheetUrlArray:[],objectJsonUrl:null},spriteSheets:[],storedObjects:[],load:function(e){let t=this;if(0==t.source.spriteSheetUrlArray.length)return void console.error("WESA Loader: No sprite sheet added.");if(!t.source.objectJsonUrl)return void console.error("WESA Loader: No object added.");let i=0,o=!1;var r=[],h=null;let u=t.source.spriteSheetUrlArray;function d(d){if("image"==d?i++:(d="object")&&(o=!0),i==u.length&&o){let i=JSON.parse(h);for(let e=0;e<i.spriteSheetsMeta.length;e++){let o=i.spriteSheetsMeta[e],a=new s({ssid:e,rowCount:o.rowCount,colCount:o.colCount,cellWidth:o.cellWidth,cellHeight:o.cellHeight});a.loadTextureFromImage(n.handle.gl,r[e]),t.spriteSheets.push(a)}for(let e=0;e<i.objects.length;e++){let o=i.objects[e],n=new c({oid:o.id,type:o.type,name:o.name});if(o.hasOwnProperty("inherits")){let e=t.storedObjects[o.inherits];e?(e.frameLib&&(n.frameLib=e.frameLib.slice()),e.animations&&(n.animations=e.animations.slice())):console.warn('wesaAssets.load(): Object "'+o.name+'" is inheriting from an undefined object.')}if(o.frames){n.frameLib=[];for(let e=0;e<o.frames.length;e++){let i=o.frames[e];if("array"==i.loadMode)for(let e=0;e<i.cells.rowCount*i.cells.colCount;e++){let o=i.idStart+e;if(n.frameLib[o])console.error('wesaAssets.load(): WESAFrame conflicts on WESAStoredObject "'+n.name+'". Frame #"'+o+'".');else{let r=i.cells.rowStart+Math.floor(e/i.cells.colCount),s=i.cells.colStart+e%i.cells.colCount;n.frameLib[o]=new a({spriteSheet:t.spriteSheets[i.spriteSheet],cell:{row:r,col:s,rowSpan:1,colSpan:1},center:{x:i.center.x,y:i.center.y}})}}else"single"==i.loadMode?n.frameLib[i.id]?console.error('wesaAssets.load(): WESAFrame conflicts on WESAStoredObject "'+n.name+'". Frame #"'+i.id+'".'):n.frameLib[i.id]=new a({spriteSheet:t.spriteSheets[i.spriteSheet],cell:{row:i.cell.row,col:i.cell.col,rowSpan:i.cell.rowSpan,colSpan:i.cell.colSpan},center:{x:i.center.x,y:i.center.y}}):console.error('wesaAssets.load(): Missing frame loading mode when loading frames for "'+n.name+'". Got "'+i.loadMode+'".')}}if(o.animations){n.animations=[];for(let e=0;e<o.animations.length;e++){let t=o.animations[e],i=new l({aid:t.id,name:t.name,next:t.hasOwnProperty("next")?t.next:t.id});t.hasOwnProperty("collision")?(i.collision.hit=t.collision.hasOwnProperty("hit")?t.collision.hit:null,i.collision.hurt=t.collision.hasOwnProperty("hurt")?t.collision.hurt:null):o.hasOwnProperty("defaultCollision")&&(i.collision.hit=o.defaultCollision.hasOwnProperty("hit")?o.defaultCollision.hit:null,i.collision.hurt=o.defaultCollision.hasOwnProperty("hurt")?o.defaultCollision.hurt:null),i.setFrames(t.frameList.slice(),t.frameTimeList.slice()),n.addAnimation(t.id,i)}}t.storedObjects[o.id]=n}e()}}for(let e=0;e<u.length;e++)r[e]=new Image,r[e].src=u[e],r[e].onload=function(){d("image")},r[e].onerror=function(){console.warning('WESA Loader: Image "'+urlArray[e]+'" load failed.'),d("image")};let p=new XMLHttpRequest;p.open("GET",this.source.objectJsonUrl),p.onload=function(){p.status>=200&&p.status<400?(h=p.responseText,d("object")):console.error('WESA Loader: Cannot load JSON "'+this.source.objectJsonUrl+'".')},p.onerror=function(){console.error('WESA Loader: Cannot load JSON "'+this.source.objectJsonUrl+'" (connection error).')},p.send()}},o={fps:0,collisionChecks:0,collisionsDetected:0,paused:!1},n={handle:{gl:null,shader:null,buffer:null},config:{shaderSource:{vs:"\n                        attribute vec4 aVertexPosition;\n                        attribute vec2 aTextureCoord;\n                        uniform mat4 uModelViewMatrix;\n                        uniform mat4 uProjectionMatrix;\n                        varying highp vec2 vTextureCoord;\n                        void main() {\n                            gl_Position = uProjectionMatrix * uModelViewMatrix * aVertexPosition;\n                            vTextureCoord = aTextureCoord;\n                        }\n                    ",fs:"\n                        varying highp vec2 vTextureCoord;\n                        uniform sampler2D uSampler;\n                        void main(void) {\n                            gl_FragColor = texture2D(uSampler, vTextureCoord);\n                        }\n                    "}},canvasResize:function(){let t=this.handle.gl,i=this.handle.shader,o=-t.canvas.width/2,n=t.canvas.width/2,r=-t.canvas.height/2,s=t.canvas.height/2,a=e.ortho(o,n,r,s,.1,100);t.uniformMatrix4fv(i.uniformLocations.projectionMatrix,!1,a),t.viewport(0,0,t.canvas.width,t.canvas.height)},init:function(i){if(!i||"CANVAS"!=i.tagName)return void console.error("WESA Core: Canvas provided is invalid.");const o=i.getContext("webgl");if(!o)return void console.error("WESA Core: Unable to initialize WebGL. Your browser or machine may not support it.");const n=function(e,i,o){const n=t(e,e.VERTEX_SHADER,i),r=t(e,e.FRAGMENT_SHADER,o),s=e.createProgram();return e.attachShader(s,n),e.attachShader(s,r),e.linkProgram(s),e.getProgramParameter(s,e.LINK_STATUS)?s:(console.error("WESA Core: Unable to initialize the shader program: "+e.getshaderProgramInfoLog(s)),null)}(o,this.config.shaderSource.vs,this.config.shaderSource.fs),r={program:n,attribLocations:{vertexPosition:o.getAttribLocation(n,"aVertexPosition"),textureCoord:o.getAttribLocation(n,"aTextureCoord")},uniformLocations:{projectionMatrix:o.getUniformLocation(n,"uProjectionMatrix"),modelViewMatrix:o.getUniformLocation(n,"uModelViewMatrix"),uSampler:o.getUniformLocation(n,"uSampler")}},s={positions:o.createBuffer(),texCoords:o.createBuffer(),indices:o.createBuffer()};!function(t,i){t.clearColor(0,0,0,1),t.clearDepth(1),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.useProgram(i.program);let o=-t.canvas.width/2,n=t.canvas.width/2,r=-t.canvas.height/2,s=t.canvas.height/2,a=e.ortho(o,n,r,s,.1,100);t.uniformMatrix4fv(i.uniformLocations.projectionMatrix,!1,a);let l=e.fromTranslation([0,0,-6]);t.uniformMatrix4fv(i.uniformLocations.modelViewMatrix,!1,l),t.activeTexture(t.TEXTURE0),t.uniform1i(i.uniformLocations.uSampler,0),t.enableVertexAttribArray(i.attribLocations.vertexPosition),t.enableVertexAttribArray(i.attribLocations.textureCoord)}(o,r),this.handle.gl=o,this.handle.shader=r,this.handle.buffer=s},pause:function(){o.paused=!o.paused}},r={position:{x:0,y:0},zoom:1};function s(e){this.ssid=e.ssid,this.rowCount=e.rowCount,this.colCount=e.colCount,this.cellWidth=e.cellWidth,this.cellHeight=e.cellHeight,this.texture=null}function a(e){this.spriteSheet=e.spriteSheet,this.cell={row:e.cell.row,col:e.cell.col,rowSpan:e.cell.rowSpan,colSpan:e.cell.colSpan},this.center={x:e.center.x,y:e.center.y},this.collision={hit:null,hurt:null},this.width=e.spriteSheet.cellWidth*e.cell.colSpan,this.height=e.spriteSheet.cellHeight*e.cell.rowSpan}function l(e){this.aid=e.aid,this.name=e.name,this.next=e.next,this.frameList=[],this.endTimeList=[],this.collision={hit:null,hurt:null}}function c(e){this.oid=e.oid,this.type=e.type,this.name=e.name,this.frameLib=null,this.animations=null}function h(e){this.object=e.object,this.action=e.action,this.team=e.team,this.position={x:e.position.x,y:e.position.y},this.scale="number"==typeof e.scale?{x:e.scale,y:e.scale}:{x:e.scale.x,y:e.scale.y},this.prevPosition={x:0,y:0},this.aiList=[],this.velocity={x:0,y:0},this.acceleration={x:0,y:0},this.scene=null,this.frameNum=0,this.state=0,this.time=0,this.deadFlag=!1,this.delayedActionChange=null,this.collision={mode:h.CollisionMode.BY_SPRITE,hit:null,hurt:null}}function u(){this.self=null,this.target=null,this.execute=null}function d(e){this.lid=e.lid,this.spriteList=[],this.batchData=null}function p(e){this.name=e,this.layerList=[]}return s.prototype.loadTextureFromImage=function(e,t){this.texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.texture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)},s.prototype.getCellCount=function(){return this.rowCount*this.colCount},s.prototype.getTextureClipByIndex=function(e){var t={},i=1/this.colCount,o=1/this.rowCount;return t.x1=i*(e%this.colCount),t.x2=t.x1+i*cellCount,t.y1=o*Math.floor(e/this.colCount),t.y2=t.y1+o,t},s.prototype.getTextureClipByPosition=function(e,t,i=1,o=1){var n={},r=1/this.colCount,s=1/this.rowCount;return n.x1=r*t,n.x2=n.x1+r*o,n.y1=s*e,n.y2=n.y1+s*i,n},l.prototype.setFrames=function(e,t){var i=e.length,o=0;this.frameList=e;for(let e=0;e<i;e++)o+=t[e],this.endTimeList[e]=o},c.prototype.addAnimation=function(e,t){this.animations[e]=t},c.prototype.addAnimationByArray=function(e){this.animations=e.slice()},h.CollisionMode=Object.freeze({BY_SPRITE:"BY_SPRITE",BY_ANIMATION:"BY_ANIMATION",BY_FRAME:"BY_FRAME"}),h.CollisionShape=Object.freeze({CIRCLE:"CIRCLE",RECT:"RECT"}),h.prototype.getCurrentAnim=function(){return this.object.animations[this.action]},h.prototype.getCurrentFrame=function(){return this.object.frameLib[this.getCurrentAnim().frameList[this.frameNum]]},h.prototype.changeAction=function(e,t){t.isSmart&&this.action==e||(t.isImmediate?(this.action=e,this.time=0,this.frameNum=0):this.delayedActionChange=e)},h.prototype.setTime=function(e){let t=this.object.animations[this.action].endTimeList,i=t[t.length-1];e<0&&(e=0),e>=i&&(e=i-1),this.time=e;for(let i=0;i<t.length;i++)if(e<t[i]){this.frameNum=i;break}},h.prototype.addAI=function(e){e.self=this,this.aiList.push(e)},h.prototype.addAIWithExecFunc=function(e){if("function"!=typeof e)return void console.error('WESASprite: Parameter of addAIWithExecFunc() must be function. Object: "'+this.object.name+'"');let t=new u;t.execute=e,t.self=this,this.aiList.push(t)},h.prototype.kill=function(){this.deadFlag=!0},h.prototype.update=function(){for(let e=0;e<this.aiList.length;e++)this.aiList[e].execute();let e=this.object.animations[this.action];if(!e)return void console.error("WESASprite: No animation for action #"+this.action+'. Object: "'+this.object.name+'"');let t=e.frameList.length;this.time++,this.time>=e.endTimeList[this.frameNum]&&(this.frameNum++,this.time>=e.endTimeList[t-1]&&(this.time=0),this.frameNum>=t&&(this.frameNum=0,null!=e.next?e.next!=this.action&&this.changeAction(e.next,{isSmart:!1,isImmediate:!0}):this.kill())),this.prevPosition.x=this.position.x,this.prevPosition.y=this.position.y,this.position.x+=this.velocity.x,this.position.y+=this.velocity.y,this.velocity.x+=this.acceleration.x,this.velocity.y+=this.acceleration.y,this.delayedActionChange&&(this.changeAction(this.delayedActionChange,{isSmart:!1,isImmediate:!0}),this.delayedActionChange=null)},d.prototype.addSprite=function(e){this.spriteList.push(e)},d.prototype.update=function(){let e=this.spriteList;for(let t=0;t<e.length;t++)e[t].deadFlag||e[t].update();for(let t=e.length-1;t>=0;t--)e[t].deadFlag&&e.splice(t,1)},d.prototype.render=function(e,t,o){this.batchData=[];for(let e=0;e<this.spriteList.length;e++)if(this.spriteList[e]){let t=this.spriteList[e],i=t.getCurrentFrame();if(i){let e,o,n,r,s,a=i.spriteSheet.ssid;if(!(t instanceof h))return void console.error("WESALayer: An error occurred when rendering: Unknown sprite type: "+t.constructor.name);if(o=(e=t.position.x-i.center.x*t.scale.x)+i.width*t.scale.x,r=(n=t.position.y-i.center.y*t.scale.y)+i.height*t.scale.y,s=i.spriteSheet.getTextureClipByPosition(i.cell.row,i.cell.col,i.cell.rowSpan,i.cell.colSpan),this.batchData[a]){this.batchData[a].spriteCount++;let t=4*(this.batchData[a].spriteCount-1);this.batchData[a].positions.push(e,n,o,n,e,r,o,r),this.batchData[a].texCoords.push(s.x1,s.y2,s.x2,s.y2,s.x1,s.y1,s.x2,s.y1),this.batchData[a].indices.push(t,t+1,t+2,t+1,t+2,t+3)}else this.batchData[a]={spriteCount:1,positions:[e,n,o,n,e,r,o,r],texCoords:[s.x1,s.y2,s.x2,s.y2,s.x1,s.y1,s.x2,s.y1],indices:[0,1,2,1,2,3]}}}for(let n=0;n<this.batchData.length;n++)this.batchData[n]&&(e.bindBuffer(e.ARRAY_BUFFER,o.positions),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.batchData[n].positions),e.STATIC_DRAW),e.vertexAttribPointer(t.attribLocations.vertexPosition,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,o.texCoords),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.batchData[n].texCoords),e.STATIC_DRAW),e.vertexAttribPointer(t.attribLocations.textureCoord,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,o.indices),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.batchData[n].indices),e.STATIC_DRAW),e.bindTexture(e.TEXTURE_2D,i.spriteSheets[n].texture),e.drawElements(e.TRIANGLES,this.batchData[n].indices.length,e.UNSIGNED_SHORT,0))},p.prototype.addSpriteToLayer=function(e,t){if(!this.layerList[e]){var i=new d({lid:e});this.layerList[e]=i}this.layerList[e].addSprite(t),t.layer=this.layerList[e],t.scene=this},p.prototype.clear=function(){this.layerList=[]},p.prototype.getCollisions=function(e){let t=[];if(e.layerIndexes)for(let e=0;e<layerIndexes.length;e++)this.layerList[layerIndexes[e]]&&t.push(this.layerList[layerIndexes[e]].spriteList);else for(let e=0;e<this.layerList.length;e++)this.layerList[e]&&t.push(this.layerList[e].spriteList);let i=[].concat.apply([],t),n=[],r=0;for(let t=0;t<i.length;t++)for(let o=0;o<i.length;o++){if(t==o)continue;let s,a,l=i[t],c=i[o];if((!e.collisionMatrix||e.collisionMatrix[l.object.type][c.object.type])&&(l.collision.mode==h.CollisionMode.BY_SPRITE?s=l.collision.hit:l.collision.mode==h.CollisionMode.BY_ANIMATION?s=l.getCurrentAnim().collision.hit:(l.collision.mode,h.CollisionMode.BY_FRAME),c.collision.mode==h.CollisionMode.BY_SPRITE?a=c.collision.hurt:c.collision.mode==h.CollisionMode.BY_ANIMATION?a=c.getCurrentAnim().collision.hurt:(c.collision.mode,h.CollisionMode.BY_FRAME),s&&a)){let e={shape:s.shape},t={shape:a.shape};if(e.shape==h.CollisionShape.CIRCLE?(e.center={x:l.position.x+s.centerRelative.x,y:l.position.y+s.centerRelative.y},e.radius=s.radius):e.shape==h.CollisionShape.RECT&&(e.x1=l.position.x+s.x1Relative,e.x2=l.position.x+s.x2Relative,e.y1=l.position.y+s.y1Relative,e.y2=l.position.y+s.y2Relative),t.shape==h.CollisionShape.CIRCLE?(t.center={x:c.position.x+a.centerRelative.x,y:c.position.y+a.centerRelative.y},t.radius=a.radius):t.shape==h.CollisionShape.RECT&&(t.x1=c.position.x+a.x1Relative,t.x2=c.position.x+a.x2Relative,t.y1=c.position.y+a.y1Relative,t.y2=c.position.y+a.y2Relative),e.shape==h.CollisionShape.CIRCLE&&t.shape==h.CollisionShape.CIRCLE){let i=e.center.x,o=t.center.x,r=e.center.y,s=t.center.y,a=i-o,h=r-s,u=Math.sqrt(a*a+h*h),d=e.radius,p=t.radius;d+p>u&&n.push({hitter:l,hurter:c,collisionPoint:{x:(p*p*i+d*d*o)/(d*d+p*p),y:(p*p*r+d*d*s)/(d*d+p*p)}})}else if(e.shape==h.CollisionShape.CIRCLE&&t.shape==h.CollisionShape.RECT){let i,o,r=0,s=0;e.center.x<t.x1?(r=t.x1-e.center.x,i=t.x1):e.center.x>t.x2?(r=e.center.x-t.x2,i=t.x2):i=e.center.x,e.center.y<t.y1?(s=t.y1-e.center.y,o=t.y1):e.center.y>t.y2?(s=e.center.y-t.y2,o=t.y2):o=e.center.y;let a=Math.sqrt(r*r+s*s);e.radius>a&&n.push({hitter:l,hurter:c,collisionPoint:{x:i,y:o}})}else e.shape==h.CollisionShape.RECT&&t.shape==h.CollisionShape.CIRCLE||e.shape==h.CollisionShape.RECT&&t.shape==h.CollisionShape.RECT&&e.x1<=t.x2&&e.y1<=t.y2&&e.x2>=t.x1&&e.y2>=t.y1&&n.push({hitter:l,hurter:c,collisionPoint:{x:(e.x1+e.x2+t.x1+t.x2)/4,y:(e.y1+e.y2+t.y1+t.y2)/4}});r++}}return o.collisionChecks=r,o.collisionsDetected=n.length,n},p.prototype.update=function(){if(!o.paused)for(let e=0;e<this.layerList.length;e++)this.layerList[e]&&this.layerList[e].update()},p.prototype.render=function(){let t=n.handle.gl,i=n.handle.shader,o=n.handle.buffer;t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.uniformMatrix4fv(i.uniformLocations.modelViewMatrix,!1,e.fromTranslation([-r.position.x,-r.position.y,-6]));for(let e=0;e<this.layerList.length;e++)this.layerList[e]&&this.layerList[e].render(t,i,o)},{SpriteSheet:s,Frame:a,Animation:l,StoredObject:c,Sprite:h,AI:u,Scene:p,core:n,assets:i,camera:r,stat:o}}())}(window);